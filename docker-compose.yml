version: '3.7'
services:

  ###########################
  ###### Car 1 ##############
  ###########################

  mosquitto_1:
    image: "eclipse-mosquitto"
    container_name: "mosquitto_1"
  centralstation_1:
    build:
      context: .
      dockerfile: centralfile
    environment:
      - 'stationname=Station1'
      - 'nginxip=nginx'
      - 'nginxport=56565'
      - 'mqttbroker=tcp://mosquitto_1:1883'
      - 'mqtttopic=hda/group_e_9/VS'
    depends_on:
      - nginx
    ports:
      - 8080:8080
  sensor-1:
    restart: on-failure
    build:
      context: .
      dockerfile: sensorfile
    depends_on:
      - mosquitto_1
    environment:
      - 'ip=centralStation'
      - 'port=51021'
      - 'sensortype=TravelDistance'
      - 'mqttbroker=tcp://mosquitto_1:1883'
      - 'mqtttopic=hda/group_e_9/VS'
  sensor-2:
    restart: on-failure
    build:
      context: .
      dockerfile: sensorfile
    depends_on:
      - mosquitto_1
    environment:
      - 'ip=centralStation'
      - 'port=51021'
      - 'sensortype=Fuel_Level'
      - 'mqttbroker=tcp://mosquitto_1:1883'
      - 'mqtttopic=hda/group_e_9/VS'
  sensor-3:
    restart: on-failure
    build:
      context: .
      dockerfile: sensorfile
    depends_on:
      - mosquitto_1
    environment:
      - 'ip=centralStation'
      - 'port=51021'
      - 'sensortype=AvgSpeed'
      - 'mqttbroker=tcp://mosquitto_1:1883'
      - 'mqtttopic=hda/group_e_9/VS'
  sensor-4:
    restart: on-failure
    build:
      context: .
      dockerfile: sensorfile
    depends_on:
      - mosquitto_1
    environment:
      - 'ip=centralStation'
      - 'port=51021'
      - 'sensortype=TrafficState'
      - 'mqttbroker=tcp://mosquitto_1:1883'
      - 'mqtttopic=hda/group_e_9/VS'
  ###########################
  ###### Car 2 ##############
  ###########################
  mosquitto_2:
    image: "eclipse-mosquitto"
    container_name: "mosquitto-2"
  sensor-6:
    restart: on-failure
    build:
      context: .
      dockerfile: sensorfile
    depends_on:
      - mosquitto_2
    environment:
      - 'ip=centralStation'
      - 'port=51021'
      - 'sensortype=Fuel_Level'
      - 'mqttbroker=tcp://mosquitto_2:1883'
      - 'mqtttopic=hda/group_e_9/VS'
  sensor-5:
    restart: on-failure
    build:
      context: .
      dockerfile: sensorfile
    depends_on:
      - mosquitto_2
    environment:
      - 'ip=centralStation'
      - 'port=51021'
      - 'sensortype=TravelDistance'
      - 'mqttbroker=tcp://mosquitto_2:1883'
      - 'mqtttopic=hda/group_e_9/VS'
  sensor-7:
    restart: on-failure
    build:
      context: .
      dockerfile: sensorfile
    depends_on:
      - mosquitto_2
    environment:
      - 'ip=centralStation'
      - 'port=51021'
      - 'sensortype=TrafficState'
      - 'mqttbroker=tcp://mosquitto_2:1883'
      - 'mqtttopic=hda/group_e_9/VS'
  sensor-8:
    restart: on-failure
    build:
      context: .
      dockerfile: sensorfile
    depends_on:
      - mosquitto_2
    environment:
      - 'ip=centralStation'
      - 'port=51021'
      - 'sensortype=AvgSpeed'
      - 'mqttbroker=tcp://mosquitto_2:1883'
      - 'mqtttopic=hda/group_e_9/VS'
  centralstation_2:
    build:
      context: .
      dockerfile: centralfile
    environment:
      - 'stationname=Station2'
      - 'nginxip=nginx'
      - 'nginxport=56565'
      - 'mqttbroker=tcp://mosquitto_2:1883'
      - 'mqtttopic=hda/group_e_9/VS'
    depends_on:
      - nginx
    ports:
      - 8084:8080
  ###########################
  ###### Backend ############
  ###########################
  serviceprovider_1:
    restart: always
    depends_on:
      - node3
#      - mongo-client
    build:
      context: .
      dockerfile: serviceproviderfile
#    networks:
#      - backend
    environment:
      - 'dbip=mongo'
      - 'dbport=27017'
      - 'rpcport=56565'
  serviceprovider_2:
    restart: always
    depends_on:
      - node3
#      - mongo-client
    build:
      context: .
      dockerfile: serviceproviderfile
#    networks:
#      - backend
    environment:
      - 'dbip=mongo'
      - 'dbport=27017'
      - 'rpcport=56565'
  serviceprovider_3:
    restart: always
    depends_on:
      - node3
#      - mongo-client
    build:
      context: .
      dockerfile: serviceproviderfile
#    networks:
#      - backend
    environment:
      - 'dbip=mongo'
      - 'dbport=27017'
      - 'rpcport=56565'
  mongo:
    image: mongo
    ports:
      - 30001:27017
    volumes:
      - ./backenddata/node1:/data/db
#    networks:
#      - backend
    command: mongod --replSet comments
  node2:
    image: mongo
    ports:
      - 30002:27017
    volumes:
      - ./backenddata/node2:/data/db
#    networks:
#      - backend
    command: mongod --replSet comments
    depends_on :
      - mongo
  node3:
    image: mongo
    ports:
      - 30003:27017
    volumes:
      - ./backenddata/node3:/data/db
#    networks:
#      - backend
    command: mongod --replSet comments
    depends_on :
      - node2
  mongo-client:
    image: mongo-express:latest
    restart: on-failure
    ports:
      - 8081:8081
    depends_on:
      - node3
  nginx:
    build:
      context: .
      dockerfile: proxyfile
    ports:
      - "8082:80"
    depends_on:
      - serviceprovider_1
      - serviceprovider_2

#networks:
#  backend:
#    driver: bridge
#  car:
#    driver: bridge